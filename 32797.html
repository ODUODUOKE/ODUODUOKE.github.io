<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Linux下设置防火墙拦截其他IP对SSH端口访问 | MBlog</title><meta name="author" content="MUMU"><meta name="copyright" content="MUMU"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="linux firewalld 查看防火墙规则 CentOS7使用firewall-cmd打开关闭防火墙与端口 以开放8080端口为例 CENTOS7中FIREWALL防火墙  IpTables  基于Centos6 及以下版本  允许特定IP访问SSH端口  -I:表示在头部（大写的i）, -A:表示追加到底部  &#x2F;sbin&#x2F;iptables -A INPUT -p tcp --dport 22"><meta property="og:type" content="article"><meta property="og:title" content="Linux下设置防火墙拦截其他IP对SSH端口访问"><meta property="og:url" content="https://www.wo0ow.com/32797.html"><meta property="og:site_name" content="MBlog"><meta property="og:description" content="linux firewalld 查看防火墙规则 CentOS7使用firewall-cmd打开关闭防火墙与端口 以开放8080端口为例 CENTOS7中FIREWALL防火墙  IpTables  基于Centos6 及以下版本  允许特定IP访问SSH端口  -I:表示在头部（大写的i）, -A:表示追加到底部  &#x2F;sbin&#x2F;iptables -A INPUT -p tcp --dport 22"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://avatars.githubusercontent.com/u/124662384"><meta property="article:published_time" content="2024-05-07T06:53:10.000Z"><meta property="article:modified_time" content="2024-07-01T06:38:37.422Z"><meta property="article:author" content="MUMU"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://avatars.githubusercontent.com/u/124662384"><link rel="shortcut icon" href="/custom/favicon/favicon-32x32.png"><link rel="canonical" href="https://www.wo0ow.com/32797.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/content.json",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:200},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-right"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!1,rightside:!1}}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Linux下设置防火墙拦截其他IP对SSH端口访问",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-07-01 14:38:37"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom/footer.css"><link rel="stylesheet" href="/css/custom/background.css"><link rel="stylesheet" href="/css/custom/mouse.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="MBlog" type="application/atom+xml"></head><body><script>window.paceOptions={restartOnPushState:!1},document.addEventListener("pjax:send",()=>{Pace.restart()})</script><link rel="stylesheet" href="/css/custom/pagejs/pace.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/124662384" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">272</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">91</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-list"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-solid fa-splotch"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background:linear-gradient(60deg,#29323c 0,#485563 100%)"><nav id="nav"><span id="blog-info"><a href="/" title="MBlog"></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-list"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-solid fa-splotch"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux下设置防火墙拦截其他IP对SSH端口访问</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-07T06:53:10.000Z" title="发表于 2024-05-07 14:53:10">2024-05-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-01T06:38:37.422Z" title="更新于 2024-07-01 14:38:37">2024-07-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43951230/article/details/103492462">linux firewalld 查看防火墙规则</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq754772661/article/details/115233110">CentOS7使用firewall-cmd打开关闭防火墙与端口 以开放8080端口为例</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/faithH/p/11811286.html">CENTOS7中FIREWALL防火墙</a></p><hr><h2 id="IpTables">IpTables</h2><blockquote><p>基于Centos6 及以下版本</p></blockquote><h3 id="允许特定IP访问SSH端口">允许特定IP访问SSH端口</h3><blockquote><p><strong>-I:表示在头部（大写的i）</strong>,<br><strong>-A:表示追加到底部</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sbin/iptables -A INPUT -p tcp --dport 22 -s 192.168.1.100/32 -j ACCEPT</span><br></pre></td></tr></table></figure><p>拒绝其他IP访问SSH端口</p><blockquote><p>危险：将导致拒绝所有其他ip地址访问22端口（已中招！！呆逼…自述）</p></blockquote><p><s>/sbin/iptables -A INPUT -p tcp --dport 22 -j DROP</s></p><h3 id="查看验证">查看验证</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service iptables save &amp;&amp; service iptables restart </span><br></pre></td></tr></table></figure><h3 id="删除防火墙规则">删除防火墙规则</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -L -n --line-number</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -D INPUT 3 #删除INPUT的第三条已添加规则，这里3代表第几行规则</span><br></pre></td></tr></table></figure><p>查看防火墙规则配置文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure><h3 id="统计防火墙已配置规则">统计防火墙已配置规则</h3><blockquote><p><code>ACCEPT</code>: 表示以<code>ACCEPT</code>开头的记录行</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -L | grep -E &#x27;^ACCEPT&#x27; | wc -l</span><br></pre></td></tr></table></figure><h3 id="防火墙是否开启">防火墙是否开启</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service iptables status;</span><br></pre></td></tr></table></figure><blockquote><p>没有开启则输出：<code>iptables: Firewall is not running.</code> 【注意：并不代表所以情况均如此!!!】-&gt; 见下文</p></blockquote><hr><h2 id="Firewalld">Firewalld</h2><blockquote><p>基于Centos7及以上版本</p></blockquote><p>Firewalld</p><h3 id="允许特定IP访问SSH端口-2">允许特定IP访问SSH端口</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --add-rich-rule=&#x27;rule family=&quot;ipv4&quot; source address=&quot;192.168.1.100/32&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&#x27;</span><br></pre></td></tr></table></figure><p>拒绝其他IP访问SSH端口</p><blockquote><p>危险：将导致拒绝所有其他ip地址访问22端口（已中招！！呆逼…自述）</p></blockquote><p><s>sudo firewall-cmd --permanent --add-rich-rule=‘rule family=“ipv4” source address=“0.0.0.0/0” port protocol=“tcp” port=“22” reject’</s></p><h3 id="重载规则">重载规则</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h3 id="查看规则">查看规则</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure><h3 id="删除规则">删除规则</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --remove-rich-rule &#x27;要删除的防火墙规则&#x27;</span><br></pre></td></tr></table></figure><blockquote><p>示例：<code>firewall-cmd --permanent --remove-rich-rule 'rule family=&quot;ipv4&quot; source address=&quot;xx.xxx.5.1/32&quot; port port=&quot;22&quot; protocol=&quot;tcp&quot; accept'</code></p></blockquote><p>查看防火墙规则配置文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /etc/firewalld/zones/public.xml</span><br></pre></td></tr></table></figure><p><strong>掩码：知识补充</strong></p><p>CIDR（Classless Inter-Domain Routing）表示法中的掩码格式用于指定IP地址范围。下面是常见的CIDR表示法：</p><p><code>/0</code>：表示<code>全范围</code>，即0.0.0.0/0，它匹配所有可能的IP地址，相当于没有过滤，因为子网掩码为0时，IP地址的每一位都是可变的。</p><p><code>/32</code>：表示<code>单个IP地址</code>，例如192.168.1.1/32，它匹配一个特定的IP地址，因为子网掩码为32时，IP地址的每一位都是固定的。</p><p><code>/24</code>：表示<code>一个子网</code>，例如192.168.1.0/24，它匹配192.168.1.0到192.168.1.255之间的所有IP地址，因为子网掩码为24时，IP地址的前24位是网络部分，后8位是主机部分，可以有256个不同的地址。</p><h2 id="【旧】判断当前防火墙类型">【旧】判断当前防火墙类型</h2><blockquote><p>将<code>Firewalld</code>防火墙检测在前，然后<code>Iptables</code>防火墙检测在后。</p></blockquote><p>在<code>麒麟</code>服务器中发现，同时具有<code>Iptables</code>和<code>Firewalld</code>,且默认开启的为<code>Firewalld</code>,在执行脚本<code>sh</code>时由<code>service iptables status</code>导致重定向命令<code>systemctl status iptables.service</code>开启了防火墙<code>iptables</code>关闭了<code>Firewalld</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 检查是否正在使用 firewalld</span><br><span class="line">if [ -f /etc/firewalld/firewalld.conf ]; then</span><br><span class="line">    echo &quot;当前正在使用 firewalld。&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 检查是否正在使用 iptables</span><br><span class="line">if [ -f /etc/sysconfig/iptables ]; then</span><br><span class="line">    echo &quot;当前正在使用 iptables。&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;无法确定当前使用的防火墙。&quot;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure><h3 id="补充信息">补充信息</h3><p>由于centos6下部分服务器存在差异情况：<br>执行命令<code>service iptables status;</code>会出现两种情况返回输出：</p><ol><li></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables: Firewall is not running.</span><br></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead) since Wed 2024-05-08 10:19:53 CST; 13min ago</span><br><span class="line">  Process: 358493 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 358645 ExecStop=/usr/libexec/iptables/iptables.init stop (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 358493 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">5月 08 10:03:25 qilinmbgui systemd[1]: Starting IPv4 firewall with iptables...</span><br><span class="line">5月 08 10:03:25 qilinmbgui iptables.init[358493]: iptables: Applying firewall rules: [  OK  ]</span><br><span class="line">5月 08 10:03:25 qilinmbgui systemd[1]: Started IPv4 firewall with iptables.</span><br><span class="line">5月 08 10:19:53 qilinmbgui systemd[1]: Stopping IPv4 firewall with iptables...</span><br><span class="line">5月 08 10:19:53 qilinmbgui iptables.init[358645]: iptables: Setting chains to policy ACCEPT: nat mangle raw security filter [FAILED]</span><br><span class="line">5月 08 10:19:53 qilinmbgui iptables.init[358645]: iptables: Flushing firewall rules: [  OK  ]</span><br><span class="line">5月 08 10:19:53 qilinmbgui systemd[1]: iptables.service: Succeeded.</span><br><span class="line">5月 08 10:19:53 qilinmbgui systemd[1]: Stopped IPv4 firewall with iptables.</span><br></pre></td></tr></table></figure><h2 id="【新】判断当前防火墙类型（已优化）">【新】判断当前防火墙类型（已优化）</h2><p><strong>添加防火墙命令脚本（测试版本）</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 检查是否正在使用 firewalld</span><br><span class="line">if [ -f /etc/firewalld/firewalld.conf ]; then</span><br><span class="line">    echo &quot;当前正在使用 firewalld &quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 运行 firewall-cmd --state 命令并将结果保存到变量中</span><br><span class="line">    firewall_state=$(firewall-cmd --state)</span><br><span class="line"></span><br><span class="line">    # 判断防火墙状态是否为running</span><br><span class="line">    if [ &quot;$firewall_state&quot; = &quot;running&quot; ]; then</span><br><span class="line">        echo &quot;防火墙正在运行.&quot;</span><br><span class="line"></span><br><span class="line">    #############################</span><br><span class="line">    ########## 操作命令 ##########</span><br><span class="line">    #############################</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line">        echo &quot;防火墙未运行.&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 检查是否正在使用 iptables</span><br><span class="line">if [ -f /etc/sysconfig/iptables ]; then</span><br><span class="line">    echo &quot;当前正在使用 iptables。&quot;</span><br><span class="line"></span><br><span class="line">    # 运行 service iptables status 命令并检查输出</span><br><span class="line">    status_output=$(service iptables status)</span><br><span class="line"></span><br><span class="line">    # 检查输出是否包含 &quot;not running&quot;</span><br><span class="line">    if [[ &quot;$status_output&quot; != *&quot;not running&quot;* || &quot;$status_output&quot; == *&quot;Active: active&quot;* ]]; then</span><br><span class="line">        </span><br><span class="line">        # 获取当前已配置防火墙规则数量</span><br><span class="line">        if iptables -L | grep -c -E &#x27;^ACCEPT&#x27; &gt; 0; then</span><br><span class="line">            echo &quot;iptables 防火墙正在运行.&quot;</span><br><span class="line"></span><br><span class="line">            #############################</span><br><span class="line">            ########## 操作命令 ##########</span><br><span class="line">            #############################</span><br><span class="line"></span><br><span class="line">        else</span><br><span class="line">            echo &quot;iptables 服务处于停止状态&quot;</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo &quot;iptables 服务处于停止状态&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">echo &quot;无法确定当前使用的防火墙。&quot;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure><p><strong>添加防火墙命令脚本（完整版本）</strong></p><p>firewalld防火墙规则</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#添加防火墙规则（允许放行指定ip来源访问22端口）</span><br><span class="line">firewall-cmd --permanent --add-rich-rule=&#x27;rule family=&quot;ipv4&quot; source address=&quot;xx.xxx.5.1/32&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&#x27;</span><br><span class="line">firewall-cmd --permanent --add-rich-rule=&#x27;rule family=&quot;ipv4&quot; source address=&quot;xx.xxx.5.11/32&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&#x27;</span><br><span class="line">firewall-cmd --permanent --add-rich-rule=&#x27;rule family=&quot;ipv4&quot; source address=&quot;xx.xxx.x.25/32&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&#x27;</span><br><span class="line">firewall-cmd --permanent --add-rich-rule=&#x27;rule family=&quot;ipv4&quot; source address=&quot;xx.xxx.x.29/32&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&#x27;</span><br><span class="line">#应用防火墙规则</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">#输出防火墙规则</span><br><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure><p>iptables防火墙规则</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#添加防火墙规则（允许放行指定ip来源访问22端口）</span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 22 -s xx.xxx.5.1/32 -j ACCEPT</span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 22 -s xx.xxx.5.11/32 -j ACCEPT</span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 22 -s xx.xxx.x.25/32 -j ACCEPT</span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 22 -s xx.xxx.x.29/32 -j ACCEPT </span><br><span class="line">#应用防火墙规则</span><br><span class="line">service iptables save</span><br><span class="line">service iptables restart</span><br><span class="line">#输出防火墙规则</span><br><span class="line">cat /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure><h2 id="防火墙端口转发配置">防火墙端口转发配置</h2><blockquote><p>已确认！通过自定义端口转发访问，不会绕过已配置的防火墙规则。</p></blockquote><p><strong>在一般情况下，firewalld的端口转发规则是应用在防火墙流量经过转发之前的阶段，而不是在目标端口接收流量后的阶段。因此，如果你在22端口上设置了指定IP访问规则，端口转发不会绕过这些规则。</strong></p><hr><p>为避免后续在犯错，我决定留一个备用端口。<br>通过<code>Firewalld</code>端口转发，将其他自定义端口流量转发至于<code>22</code>端口，这样即使ssh的默认端口由于防火墙规则配置出错导致无法连接，我也有备用解决方案！</p><h3 id="SSH-连接自定义端口命令">SSH 连接自定义端口命令</h3><blockquote><p>格式：ssh -p 端口号 用户名@主机地址</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -p root@192.168.226.131</span><br></pre></td></tr></table></figure><h3 id="Firewalld端口转发规则">Firewalld端口转发规则</h3><h4 id="开启Firewalld端口转发">开启Firewalld端口转发</h4><blockquote><p>默认是关闭端口转发</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-masquerade --permanent</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h4 id="添加端口转发规则">添加端口转发规则</h4><p>将8080端口转发至22端口</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-forward-port=port=8080:proto=tcp:toport=22 --permanent</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h4 id="查询端口转发规则">查询端口转发规则</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --list-all</span><br></pre></td></tr></table></figure><blockquote><p>观察是否输出：<code>forward-ports:</code>port=8080:proto=tcp:toport=22:toaddr=</p></blockquote><h4 id="删除端口转发规则">删除端口转发规则</h4><blockquote><p>同上防火墙删除规则</p></blockquote><h2 id="调整SSH端口">调整SSH端口</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangmingcai/article/details/82895824">Linux系统配置ssh监听多个端口方法</a></p><p><strong>注意：如果系统升级过<code>ssh</code>，即使修改配置文件<code>/etc/ssh/sshd_config</code>也不会生效，升级<code>openssh</code>后，配置文件被修改到<code>/usr/local/etc/sshd_config</code></strong></p><h3 id="脚本命令">脚本命令</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 添加新的listenAddress配置到sshd_config文件</span><br><span class="line">echo &quot;listenAddress 0.0.0.0:22&quot; | sudo tee -a /etc/ssh/sshd_config</span><br><span class="line">echo &quot;listenAddress 0.0.0.0:2201&quot; | sudo tee -a /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line"># 修改SELinux配置文件(重启生效)</span><br><span class="line">sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line"># 检查SELinux状态并打印日志</span><br><span class="line">selinux_status=$(getenforce)</span><br><span class="line">echo &quot;SELinux status: $selinux_status&quot;</span><br><span class="line">if [ &quot;$selinux_status&quot; == &quot;Permissive&quot; ]; then</span><br><span class="line">    echo &quot;SELinux is in Permissive mode.&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;SELinux is not in Permissive mode.&quot;</span><br><span class="line">    </span><br><span class="line">    # 设置SELinux为宽容模式（立即生效）</span><br><span class="line">    setenforce 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 重启sshd服务</span><br><span class="line">service sshd restart</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="修改默认端口">修改默认端口</h3><p>例如：修改默认<code>22</code>端口为<code>2201</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Port 2201</span><br><span class="line">#AddressFamily any</span><br><span class="line">#ListenAddress 0.0.0.0</span><br><span class="line">#ListenAddress ::</span><br></pre></td></tr></table></figure><h3 id="监听多个端口">监听多个端口</h3><blockquote><p><code>selinux</code>需设置为<code>disabled</code>，否则不生效！</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Port 22</span><br><span class="line">#AddressFamily any</span><br><span class="line">listenAddress 0.0.0.0:22</span><br><span class="line">listenAddress 0.0.0.0:2201</span><br><span class="line">listenAddress 0.0.0.0:2202</span><br><span class="line">#ListenAddress ::</span><br></pre></td></tr></table></figure><h3 id="重启SSH服务">重启SSH服务</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><h3 id="查看sshd的端口情况">查看sshd的端口情况</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat -anp|grep sshd</span><br></pre></td></tr></table></figure><h3 id="补充：修改selinux">补充：修改<code>selinux</code></h3><h4 id="立即生效方案">立即生效方案</h4><p>设置宽容模式，<code>permissive</code> （不执行但产生警告）</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><p>检查设置结果</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getenforce</span><br></pre></td></tr></table></figure><hr><h4 id="需要重启方案">需要重启方案</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/selinux/config</span><br></pre></td></tr></table></figure><p>修改内容</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure><p>重启应用修改</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><p>验证修改</p><blockquote><p>如果SELinux已被禁用，命令的输出应该显示SELinux status: disabled。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sestatus</span><br></pre></td></tr></table></figure><h2 id="脚本命令-2">脚本命令</h2><h3 id="添加防火墙规则">添加防火墙规则</h3><blockquote><p>添加指定IP的SSH防火墙规则，并同时开启备用SSH端口</p></blockquote><ul><li>centos6 （待确认）</li><li>centos7 ok</li><li>麒麟 ok</li></ul><p><strong>解决复制代码格式打乱：使用 <code>:set paste</code> 命令开启 Paste 模式，这样在插入模式下粘贴内容时会关闭自动缩进，可以保持原始格式。插入模式下，使用 <code>:set nopaste</code> 命令可以关闭 Paste 模式。</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 定义配置放开的ssh端口数组</span><br><span class="line">configs=(&quot;ListenAddress 0.0.0.0:22&quot; &quot;ListenAddress 0.0.0.0:2201&quot;)</span><br><span class="line"># 定义备用SSH端口访问IP地址【备用SSH】</span><br><span class="line">bak_ip_addresses=(&quot;xx.xxx.x.25/32&quot; &quot;xx.xxx.x.29/32&quot;)</span><br><span class="line"></span><br><span class="line"># 定义要添加的IP地址和端口【主要SSH】</span><br><span class="line">ip_addresses=(&quot;xx.xxx.5.1/32&quot; &quot;xx.xxx.5.11/32&quot; &quot;xx.xxx.x.25/32&quot; &quot;xx.xxx.x.29/32&quot;)</span><br><span class="line">port=&quot;22&quot;</span><br><span class="line"></span><br><span class="line"># 定义ssh配置文件路径</span><br><span class="line">file=&quot;/etc/ssh/sshd_config&quot;</span><br><span class="line"></span><br><span class="line"># 定义selinux配置文件</span><br><span class="line">selinux_config=&quot;/etc/selinux/config&quot;</span><br><span class="line"></span><br><span class="line"># 遍历配置数组</span><br><span class="line">for config in &quot;$&#123;configs[@]&#125;&quot;; do</span><br><span class="line">    # 使用grep命令检查配置是否存在于文件中</span><br><span class="line">    if grep -q &quot;^$config&quot; &quot;$file&quot;; then</span><br><span class="line">        echo &quot;$config 配置已存在&quot;</span><br><span class="line">    else</span><br><span class="line">        # 如果配置不存在，则追加到文件中</span><br><span class="line">        echo &quot;$config&quot; | tee -a &quot;$file&quot; &gt; /dev/null</span><br><span class="line">        echo &quot;$config 配置已添加到 $file&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检查SELinux状态并打印日志</span><br><span class="line">selinux_status=$(getenforce)</span><br><span class="line">echo &quot;SELinux status: $selinux_status&quot;</span><br><span class="line">if [ &quot;$selinux_status&quot; == &quot;Permissive&quot; ] || [ &quot;$selinux_status&quot; == &quot;Disabled&quot; ] ; then</span><br><span class="line">    echo &quot;SELinux 当前属于宽容模式&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;SELinux 已修改为宽容模式&quot;</span><br><span class="line">    </span><br><span class="line">    # 修改SELinux配置文件(重启生效)</span><br><span class="line">    sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; &quot;$selinux_config&quot;</span><br><span class="line"></span><br><span class="line">    # 设置SELinux为宽容模式（立即生效）</span><br><span class="line">    setenforce 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 重启sshd服务</span><br><span class="line">service sshd restart</span><br><span class="line"></span><br><span class="line"># 检查是否正在使用 firewalld</span><br><span class="line">if [ -f /etc/firewalld/firewalld.conf ]; then</span><br><span class="line">    echo &quot;当前正在使用 firewalld &quot;</span><br><span class="line"></span><br><span class="line">    # 运行 firewall-cmd --state 命令并将结果保存到变量中</span><br><span class="line">    firewall_state=$(firewall-cmd --state)</span><br><span class="line"></span><br><span class="line">    # 判断防火墙状态是否为running</span><br><span class="line">    if [ &quot;$firewall_state&quot; = &quot;running&quot; ]; then</span><br><span class="line">        echo &quot;防火墙正在运行.&quot;</span><br><span class="line"></span><br><span class="line">    #############################</span><br><span class="line">    ########## 操作命令 ##########</span><br><span class="line"></span><br><span class="line">    # 指定规则文件路径</span><br><span class="line">    rules_file=&quot;/etc/firewalld/zones/public.xml&quot;</span><br><span class="line">    # 指定备份文件路径</span><br><span class="line">    backup_file=&quot;/etc/firewalld/zones/firewalld_backup_$(date +%Y%m%d_%H%M%S).rules&quot;</span><br><span class="line">    # 备份当前规则文件</span><br><span class="line">    cp &quot;$rules_file&quot; &quot;$backup_file&quot;</span><br><span class="line">    # 输出备份文件路径</span><br><span class="line">    echo &quot;Firewalld规则文件已备份到: $backup_file&quot;</span><br><span class="line"></span><br><span class="line">    # 循环遍历IP地址数组(firewalld没有相关方法实现对重复规则的检查，但重复的规则不会被frewalld添加到防火墙规则中。)</span><br><span class="line">    for ip in &quot;$&#123;ip_addresses[@]&#125;&quot;; do</span><br><span class="line">        # 构建规则</span><br><span class="line">        rule=&quot;rule family=\&quot;ipv4\&quot; source address=\&quot;$ip\&quot; port protocol=\&quot;tcp\&quot; port=\&quot;$port\&quot; accept&quot;</span><br><span class="line"></span><br><span class="line">        firewall-cmd --permanent --add-rich-rule=&quot;$rule&quot;</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    # 循环遍历端口数组-&gt;添加备用SSH端口访问IP地址的防火墙规则</span><br><span class="line">    for config in &quot;$&#123;configs[@]&#125;&quot;; do</span><br><span class="line">        # 提取端口号</span><br><span class="line">        port=$(echo &quot;$config&quot; | awk -F &#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">        # 循环遍历IP地址数组</span><br><span class="line">        for ip in &quot;$&#123;bak_ip_addresses[@]&#125;&quot;; do</span><br><span class="line">            # 构建规则</span><br><span class="line">            rule=&quot;rule family=\&quot;ipv4\&quot; source address=\&quot;$ip\&quot; port protocol=\&quot;tcp\&quot; port=\&quot;$port\&quot; accept&quot;</span><br><span class="line">            </span><br><span class="line">            # 添加规则</span><br><span class="line">            firewall-cmd --permanent --add-rich-rule=&quot;$rule&quot;</span><br><span class="line">            echo &quot;备用SSH_已添加规则：$rule&quot;</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    #应用防火墙规则</span><br><span class="line">    firewall-cmd --reload</span><br><span class="line">    #输出防火墙规则</span><br><span class="line">    #firewall-cmd --list-all</span><br><span class="line"></span><br><span class="line">    #############################</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line">        echo &quot;防火墙未运行.&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 检查是否正在使用 iptables</span><br><span class="line">if [ -f /etc/sysconfig/iptables ]; then</span><br><span class="line">    echo &quot;当前正在使用 iptables。&quot;</span><br><span class="line"></span><br><span class="line">    # 运行 service iptables status 命令并检查输出</span><br><span class="line">    status_output=$(service iptables status)</span><br><span class="line"></span><br><span class="line">    # 检查输出是否包含 &quot;not running&quot;</span><br><span class="line">    if [[ &quot;$status_output&quot; != *&quot;not running&quot;* || &quot;$status_output&quot; == *&quot;Active: active&quot;* ]]; then</span><br><span class="line">        </span><br><span class="line">        # 获取当前已配置防火墙规则数量</span><br><span class="line">        if iptables -L | grep -c -E &#x27;^ACCEPT&#x27; &gt; 0; then</span><br><span class="line">            echo &quot;iptables 防火墙正在运行.&quot;</span><br><span class="line"></span><br><span class="line">            #############################</span><br><span class="line">            ########## 操作命令 ##########</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">            # 指定备份文件路径</span><br><span class="line">            backup_file=&quot;/etc/sysconfig/iptables_backup_$(date +%Y%m%d_%H%M%S).rules&quot;</span><br><span class="line">            # 保存当前iptables规则到备份文件中</span><br><span class="line">            iptables-save &gt; &quot;$backup_file&quot;</span><br><span class="line">            # 输出备份文件路径</span><br><span class="line">            echo &quot;iptables规则已备份到: $backup_file&quot;</span><br><span class="line"></span><br><span class="line">            # 检查规则是否存在</span><br><span class="line">            if iptables -C INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT &amp;&gt;/dev/null; then</span><br><span class="line">                # 规则存在，删除它</span><br><span class="line">                iptables -D INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line">                echo &quot;默认允许新连接22端口：规则已删除&quot;</span><br><span class="line">            else</span><br><span class="line">                echo &quot;默认允许新连接22端口：规则不存在&quot;</span><br><span class="line">            fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            # 检查规则是否已经存在的函数</span><br><span class="line">            rule_exists() &#123;</span><br><span class="line">                local rule=&quot;$1&quot;</span><br><span class="line">                local table=&quot;$2&quot;</span><br><span class="line">                /sbin/iptables -C &quot;$table&quot; $rule &amp;&gt;/dev/null</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            # 循环遍历IP地址数组</span><br><span class="line">            for ip in &quot;$&#123;ip_addresses[@]&#125;&quot;; do</span><br><span class="line">                # 构建规则</span><br><span class="line">                rule=&quot;-p tcp --dport $port -s $ip -j ACCEPT&quot;</span><br><span class="line">                </span><br><span class="line">                # 检查规则是否已经存在</span><br><span class="line">                if ! rule_exists &quot;$rule&quot; &quot;INPUT&quot;; then</span><br><span class="line">                    # 如果规则不存在，则添加规则</span><br><span class="line">                    /sbin/iptables -I INPUT $rule</span><br><span class="line">                    echo &quot;已添加规则：$rule&quot;</span><br><span class="line">                else</span><br><span class="line">                    echo &quot;规则已存在：$rule&quot;</span><br><span class="line">                fi</span><br><span class="line">            done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            # 循环遍历端口数组-&gt;添加备用SSH端口访问IP地址的防火墙规则</span><br><span class="line">            for config in &quot;$&#123;configs[@]&#125;&quot;; do</span><br><span class="line">                # 提取端口号</span><br><span class="line">                port=$(echo &quot;$config&quot; | awk -F &#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">                # 循环遍历IP地址数组</span><br><span class="line">                for ip in &quot;$&#123;bak_ip_addresses[@]&#125;&quot;; do</span><br><span class="line">                    # 构建规则</span><br><span class="line">                    rule=&quot;-p tcp --dport $port -s $ip -j ACCEPT&quot;</span><br><span class="line">                    </span><br><span class="line">                    # 检查规则是否已经存在</span><br><span class="line">                    if ! rule_exists &quot;$rule&quot; &quot;INPUT&quot;; then</span><br><span class="line">                        # 如果规则不存在，则添加规则</span><br><span class="line">                        /sbin/iptables -I INPUT $rule</span><br><span class="line">                        echo &quot;备用SSH_已添加规则：$rule&quot;</span><br><span class="line">                    else</span><br><span class="line">                        echo &quot;规则已存在：$rule&quot;</span><br><span class="line">                    fi</span><br><span class="line">                done</span><br><span class="line">            done</span><br><span class="line"></span><br><span class="line">            #应用防火墙规则</span><br><span class="line">            service iptables save &amp;&amp; service iptables restart</span><br><span class="line">            </span><br><span class="line">            #输出防火墙规则</span><br><span class="line">            #cat /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">            #############################</span><br><span class="line"></span><br><span class="line">        else</span><br><span class="line">            echo &quot;iptables 服务处于停止状态&quot;</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo &quot;iptables 服务处于停止状态&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">echo &quot;无法确定当前使用的防火墙。&quot;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure><h3 id="OpenSSH修复CVE-2023-38408漏洞">OpenSSH修复CVE-2023-38408漏洞</h3><ul><li>centos6 fail</li><li>centos7 ok</li><li>麒麟 ok</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#https://blog.51cto.com/qiuyue/6904175</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 指定下载目录</span><br><span class="line">download_dir=&quot;/tmp/&quot;</span><br><span class="line"></span><br><span class="line"># 指定要下载的文件</span><br><span class="line">file=&quot;openssh-9.3p2.tar.gz&quot;</span><br><span class="line"></span><br><span class="line"># 指定要下载的URL</span><br><span class="line">url=&quot;https://mirrors.aliyun.com/pub/OpenBSD/OpenSSH/portable/&quot;</span><br><span class="line"></span><br><span class="line"># 检查wget是否存在</span><br><span class="line">if which wget &amp;&gt;/dev/null; then</span><br><span class="line">    echo &quot;wget已安装&quot;</span><br><span class="line">    # 使用wget下载文件到指定目录</span><br><span class="line">    wget -P &quot;$download_dir&quot; &quot;$url$file&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;wget未安装&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 备份配置文件</span><br><span class="line">cd /etc/ssh &amp;&amp; cp sshd_config&#123;,.bak&#125;</span><br><span class="line">cd /etc/pam.d &amp;&amp; cp sshd&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line"># 按照依赖包</span><br><span class="line">yum -y install gcc gcc-c++ zlib-devel openssl-devel pam-devel</span><br><span class="line"></span><br><span class="line">#编译新版本</span><br><span class="line">tar -xf &quot;$download_dir$file&quot; -C /usr/src</span><br><span class="line"></span><br><span class="line">cd /usr/src/openssh-9.3p2 &amp;&amp; ./configure --prefix=/usr --sysconfdir=/etc/ssh --with-zlib --with-pam</span><br><span class="line"></span><br><span class="line">rpm -qa | grep openssh</span><br><span class="line"></span><br><span class="line">rpm -e --nodeps `rpm -qa | grep openssh`</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">echo $?</span><br><span class="line"></span><br><span class="line"># 修复权限</span><br><span class="line">chmod 600 /etc/ssh/ssh_host_rsa_key /etc/ssh/ssh_host_ecdsa_key /etc/ssh/ssh_host_ed25519_key</span><br><span class="line"></span><br><span class="line"># 复制配置文件并授权</span><br><span class="line">cp -a contrib/redhat/sshd.init /etc/init.d/sshd &amp;&amp; chmod u+x /etc/init.d/sshd</span><br><span class="line"></span><br><span class="line"># 还原之前备份的配置文件</span><br><span class="line">cd /etc/ssh &amp;&amp; mv -f sshd_config.bak sshd_config</span><br><span class="line">cd /etc/pam.d &amp;&amp; mv -f sshd.bak sshd</span><br><span class="line"></span><br><span class="line"># 允许root用户远程登录（生产服务器一般属于`普通用户`登录后切`su`用户）</span><br><span class="line"># sed -i &#x27;s/#PermitRootLogin yes/PermitRootLogin yes/g&#x27; /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line"># 设置开机自启</span><br><span class="line">chkconfig --add sshd</span><br><span class="line">chkconfig sshd on</span><br><span class="line">chkconfig --list</span><br><span class="line"></span><br><span class="line"># 重启SSH</span><br><span class="line">systemctl restart sshd</span><br><span class="line"></span><br><span class="line"># 查看SSH版本</span><br><span class="line">ssh -V</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Centos6-升级-OpenSSH修复CVE-2023-38408漏洞">Centos6 升级 (OpenSSH修复CVE-2023-38408漏洞)</h3><blockquote><p>补充下 : centos6 更新源</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum clean all &amp;&amp; yum makecache</span><br></pre></td></tr></table></figure><hr><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/houhuilinblogs/p/18110421">Linux - centos6.6升级openssh9.7p1</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26963433/article/details/108510090">openSSH升级常见报错汇总</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45742250/article/details/134876045">【已解决】openssl: error while loading shared libraries: libssl.so.3: cannot open shared object file: No</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38924500/article/details/106783645">Centos7安装、配置SSH服务远程登录</a></p><blockquote><p>当SSH升级失败，无法登录情况下，登录VM虚机，然后在终端下重新安装openSSH服务即可。</p></blockquote><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/A496608119/article/details/116501497">完美解决 unbuntu中vim编辑完成后 按ESC毫无反映</a></p><blockquote><p>按ESC退出编辑模式：</p></blockquote><blockquote><p>再同时按 shift键和：键 就可以出现：</p></blockquote><blockquote><p>如果你按shift键+：没有反映，需要将输入法切换成英文输入法</p></blockquote><hr><p>安装环境依赖</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install gcc zlib-devel openssh-devel</span><br></pre></td></tr></table></figure><p>安装perl</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf perl-5.38.2.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./Configure -des -Dprefix=/usr/local/perl</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make &amp;&amp; make install </span><br></pre></td></tr></table></figure><p>配置环境变量</p><blockquote><p><code>/etc/profile</code></p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;export PATH=/usr/local/perl/bin/:$PATH&#x27; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">perl -v</span><br></pre></td></tr></table></figure><hr><p>安装 zlib</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf zlib.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./configure  --prefix=/usr/local/zlib</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;export LD_LIBRARY_PATH=/usr/local/zlib/lib:$LD_LIBRARY_PATH&#x27; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>检查是否具有目录<code>include</code> 、 <code>lib</code> 、 <code>share</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ls /usr/local/zlib/</span><br></pre></td></tr></table></figure><hr><p>安装 openssl</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf openssl-3.2.1.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./config --prefix=/usr/local/openssl</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;export PATH=/usr/local/openssl/bin:$PATH&#x27; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;export LD_LIBRARY_PATH=/usr/local/openssl/lib64:$LD_LIBRARY_PATH&#x27; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>刷新缓存</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ldconfig</span><br></pre></td></tr></table></figure><p>查看版本</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure><hr><p>安装openssh</p><p>解压<code>Openssh9.7p1</code>文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf openssh-9.7p1.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/usr/local/openssh --sysconfdir=/etc/ssh --with-ssl-dir=/usr/local/openssl --with-zlib=/usr/local/zlib</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>针对不支持配置进行注释</p><blockquote><p>/etc/ssh/sshd_config line 81: Unsupported option GSSAPIAuthentication<br>/etc/ssh/sshd_config line 83: Unsupported option GSSAPICleanupCredentials<br>/etc/ssh/sshd_config line 97: Unsupported option UsePAM</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -i &#x27;s/^GSSAPIAuthentication/#&amp;/&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -i &#x27;s/^GSSAPICleanupCredentials/#&amp;/&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -i &#x27;s/^UsePAM/#&amp;/&#x27; /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;export PATH=/usr/local/openssh/bin:$PATH&#x27; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>查看版本信息</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -V</span><br></pre></td></tr></table></figure><p>创建软连接</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -snf /usr/local/openssh/bin/ssh-keygen /usr/bin/ssh-keygen</span><br><span class="line"># ssh-keygen需要依赖openssl的libcrypto</span><br><span class="line">ln -snf /usr/local/openssl/lib64/libcrypto.so.3 /usr/lib64/libcrypto.so.3</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -snf /usr/local/openssh/sbin/sshd /usr/sbin/sshd</span><br></pre></td></tr></table></figure><p>重启SSH服务</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service sshd restart;</span><br></pre></td></tr></table></figure><blockquote><p>若<code>root</code>用户无法登录，则修改<code>/etc/ssh/sshd_config</code>文件，修改<code>PermitRootLogin yes</code> 即可</p></blockquote><hr><p>错误命令<br><s>./configure --prefix=/usr --sysconfdir=/etc/ssh</s></p><p>编译报错: <strong>configure: error: *** working libcrypto not found, check config.log</strong></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wholj/p/10944407.html">升级openssh编译报错“configure: error: *** working libcrypto not found, check config.log”的解决办法</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y openssl-devel</span><br></pre></td></tr></table></figure><h4 id="Centos6-升级-OpenSSH修复CVE-2023-38408漏洞-【SH脚本版】">Centos6 升级 (OpenSSH修复CVE-2023-38408漏洞)【SH脚本版】</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014114990/article/details/50310667">linux多核处理下提高编译速度 make -j</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Ben_zp/article/details/107044657">解决Linux关闭ssh连接导致执行的程序停掉的问题</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 示例代码</span><br><span class="line">nohup sh start.sh &gt; run.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># ------------------------------------------------</span><br><span class="line"></span><br><span class="line"># 定义一个生成备份文件名的方法</span><br><span class="line">generate_backup_name() &#123;</span><br><span class="line">    echo &quot;.backup_$(date +%Y%m%d_%H%M%S)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">generate_backup_date() &#123;</span><br><span class="line">    echo &quot;$(date +%Y%m%d)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 定义一个备份路径的方法</span><br><span class="line">backup_path() &#123;</span><br><span class="line">    local path=$1</span><br><span class="line">    local backup_name=$2</span><br><span class="line"></span><br><span class="line">    if [ -d &quot;$path&quot; ]; then</span><br><span class="line">        # 处理目录备份</span><br><span class="line">        local parent_dir=$(dirname &quot;$path&quot;)</span><br><span class="line">        local dir_name=$(basename &quot;$path&quot;)</span><br><span class="line">        cp -r &quot;$path&quot; &quot;$parent_dir/$dir_name$backup_name&quot; || &#123; echo &quot;Failed to backup directory $path&quot;; return 1; &#125;</span><br><span class="line">        echo &quot;Backup created: $parent_dir/$dir_name$backup_name&quot;</span><br><span class="line">    elif [ -f &quot;$path&quot; ]; then</span><br><span class="line">        # 处理文件备份</span><br><span class="line">        local dir=$(dirname &quot;$path&quot;)</span><br><span class="line">        local file=$(basename &quot;$path&quot;)</span><br><span class="line">        cp &quot;$path&quot; &quot;$dir/$file$backup_name&quot; || &#123; echo &quot;Failed to backup file $path&quot;; return 1; &#125;</span><br><span class="line">        echo &quot;Backup created: $dir/$file$backup_name&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$path does not exist&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 定义一个解压方法</span><br><span class="line">extract_tar_gz() &#123;</span><br><span class="line">    local tar_file=$1</span><br><span class="line">    local dest_dir=$2</span><br><span class="line"></span><br><span class="line">    # 检查 tar.gz 文件是否存在</span><br><span class="line">    if [ ! -f &quot;$tar_file&quot; ]; then</span><br><span class="line">        echo &quot;File $tar_file does not exist&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 检查目标目录是否存在，如果不存在则创建</span><br><span class="line">    if [ ! -d &quot;$dest_dir&quot; ]; then</span><br><span class="line">        mkdir -p &quot;$dest_dir&quot; || &#123; echo &quot;Failed to create directory $dest_dir&quot;; return 1; &#125;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 解压 tar.gz 文件到指定目录</span><br><span class="line">    tar -xzf &quot;$tar_file&quot; -C &quot;$dest_dir&quot;  || &#123; echo &quot;Failed to extract $tar_file to $dest_dir&quot;; return 1; &#125;</span><br><span class="line"></span><br><span class="line">    echo &quot;Extracted $tar_file to $dest_dir&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 定义一个提取文件名的方法(去掉`.tar.gz`)</span><br><span class="line">extract_filename_exp() &#123;</span><br><span class="line">    local url=$1</span><br><span class="line">    local basename</span><br><span class="line"></span><br><span class="line">    # 提取文件名（不包括扩展名）</span><br><span class="line">    basename=$(basename &quot;$url&quot; .tar.gz)</span><br><span class="line"></span><br><span class="line">    echo &quot;$basename&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义一个提取文件名的方法</span><br><span class="line">extract_filename() &#123;</span><br><span class="line">    local url=$1</span><br><span class="line">    local filename</span><br><span class="line"></span><br><span class="line">    # 提取 ? 前的部分</span><br><span class="line">    filename=$(echo &quot;$url&quot; | cut -d &#x27;?&#x27; -f 1)</span><br><span class="line"></span><br><span class="line">    echo &quot;$filename&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ------------------------------------------------</span><br><span class="line"></span><br><span class="line"># 指定下载目录</span><br><span class="line">download_dir=&quot;/root/&quot;</span><br><span class="line"></span><br><span class="line"># 指定要下载的URL</span><br><span class="line">URL_PRIFIX=&quot;https://XXX.aliyuncs.com/ssh_upgrade/&quot;</span><br><span class="line"></span><br><span class="line"># 指定要下载的文件</span><br><span class="line">perl_URL=&quot;perl-5.38.2.tar.gz?OSSAccessKeyId=LTAI4FnhQ9DsrVxZW9uwDd1q&amp;Expires=1716373493&amp;Signature=IaiQ9Z6XPONkqS2nZxu6v2OSVI8%3D&quot;</span><br><span class="line"></span><br><span class="line">zlib_URL=&quot;zlib-1.3.1.tar.gz?OSSAccessKeyId=LTAI4FnhQ9DsrVxZW9uwDd1q&amp;Expires=1716373463&amp;Signature=T3p9uD%2BgwE51hAbHv5er2zYqFG8%3D&quot;</span><br><span class="line"></span><br><span class="line">openSSL_URL=&quot;openssl-3.2.1.tar.gz?OSSAccessKeyId=LTAI4FnhQ9DsrVxZW9uwDd1q&amp;Expires=1716373445&amp;Signature=XO1njdaYbF1DDJ5ybrkAYf7BWNI%3D&quot;</span><br><span class="line"></span><br><span class="line">openSSH_URL=&quot;openssh-9.7p1.tar.gz?OSSAccessKeyId=LTAI4FnhQ9DsrVxZW9uwDd1q&amp;Expires=1716373429&amp;Signature=%2BKlQOrhJsUPOvlPKiCH6Ancufu8%3D&quot;</span><br><span class="line"></span><br><span class="line"># 检查wget是否存在</span><br><span class="line">if which wget &amp;&gt;/dev/null; then</span><br><span class="line">    echo &quot;wget已安装&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;wget未安装,通过yum命令安装中...安装完成后继续执行下载任务!&quot;</span><br><span class="line">    yum install -y wget</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 生成日期</span><br><span class="line">option_date=$(generate_backup_date)</span><br><span class="line"># 生成备份文件名</span><br><span class="line">backup_name=$(generate_backup_name)</span><br><span class="line"># 开始备份文件或目录</span><br><span class="line">backup_path &quot;/etc/ssh/sshd_config&quot; &quot;$backup_name&quot;</span><br><span class="line">backup_path &quot;/etc/pam.d/sshd&quot; &quot;$backup_name&quot;</span><br><span class="line">#backup_path &quot;/usr/bin/openssl&quot; &quot;$backup_name&quot;</span><br><span class="line">#backup_path &quot;/usr/lib/systemd/system&quot; &quot;$backup_name&quot;</span><br><span class="line"></span><br><span class="line"># 按照依赖包</span><br><span class="line">yum -y install gcc gcc-c++ zlib-devel openssl-devel pam-devel</span><br><span class="line"></span><br><span class="line">##开始安装perl##</span><br><span class="line">wget -O &quot;$download_dir$(extract_filename $perl_URL)&quot; &quot;$URL_PRIFIX$perl_URL&quot; #下载安装文件</span><br><span class="line">perl=$(extract_filename &quot;$perl_URL&quot;)     #从url中获取perl.tar.gz文件名</span><br><span class="line">perl_dir=$(extract_filename_exp &quot;$perl&quot;) #获取`perl`中获取解压后目录名</span><br><span class="line">extract_tar_gz &quot;$download_dir$perl&quot; &quot;/opt/$&#123;option_date&#125;/&quot; #解压文件到指定目录下</span><br><span class="line">cd /opt/$&#123;option_date&#125;/$perl_dir</span><br><span class="line">./Configure -des -Dprefix=/usr/local/perl </span><br><span class="line">make -j </span><br><span class="line">make install -j </span><br><span class="line">echo &#x27;export PATH=/usr/local/perl/bin/:$PATH&#x27; &gt;&gt; /etc/profile &amp;&amp; source /etc/profile</span><br><span class="line">perl_version=$(perl -v 2&gt;&amp;1)</span><br><span class="line">echo &quot;perl已安装，版本：$perl_version&quot;</span><br><span class="line"></span><br><span class="line">##开始安装zlib##</span><br><span class="line">wget -O &quot;$download_dir$(extract_filename $zlib_URL)&quot; &quot;$URL_PRIFIX$zlib_URL&quot;</span><br><span class="line">zlib=$(extract_filename &quot;$zlib_URL&quot;)</span><br><span class="line">zlib_dir=$(extract_filename_exp &quot;$zlib&quot;)</span><br><span class="line">extract_tar_gz &quot;$download_dir$zlib&quot; &quot;/opt/$&#123;option_date&#125;/&quot;</span><br><span class="line">cd /opt/$&#123;option_date&#125;/$zlib_dir</span><br><span class="line">./configure  --prefix=/usr/local/zlib </span><br><span class="line">make -j</span><br><span class="line">make install -j</span><br><span class="line">echo &#x27;export LD_LIBRARY_PATH=/usr/local/zlib/lib:$LD_LIBRARY_PATH&#x27; &gt;&gt; /etc/profile &amp;&amp; source /etc/profile</span><br><span class="line">zlib_check=$(ls -1 /usr/local/zlib/*)</span><br><span class="line">if [ -n &quot;$zlib_check&quot; ]; then</span><br><span class="line">    echo &quot;zlib已安装，/usr/local/zlib/目录下已存在文件：&quot;</span><br><span class="line">    echo &quot;$zlib_check&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;zlib未安装或者目录下没有文件&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">##开始安装openssl##</span><br><span class="line">wget -O &quot;$download_dir$(extract_filename $openSSL_URL)&quot; &quot;$URL_PRIFIX$openSSL_URL&quot;</span><br><span class="line">openssl=$(extract_filename &quot;$openSSL_URL&quot;)</span><br><span class="line">openssl_dir=$(extract_filename_exp &quot;$openssl&quot;)</span><br><span class="line">extract_tar_gz &quot;$download_dir$openssl&quot; &quot;/opt/$&#123;option_date&#125;/&quot;</span><br><span class="line">cd /opt/$&#123;option_date&#125;/$openssl_dir</span><br><span class="line">./config --prefix=/usr/local/openssl </span><br><span class="line">make -j</span><br><span class="line">make install -j</span><br><span class="line">echo &#x27;export PATH=/usr/local/openssl/bin:$PATH&#x27; &gt;&gt; /etc/profile</span><br><span class="line">echo &#x27;export LD_LIBRARY_PATH=/usr/local/openssl/lib64:$LD_LIBRARY_PATH&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line">ldconfig</span><br><span class="line">openssl_version=$(openssl version 2&gt;&amp;1)</span><br><span class="line">echo &quot;openssl已安装，版本：$openssl_version&quot;</span><br><span class="line"></span><br><span class="line">##开始安装openssh##</span><br><span class="line">wget -O &quot;$download_dir$(extract_filename $openSSH_URL)&quot; &quot;$URL_PRIFIX$openSSH_URL&quot;</span><br><span class="line">openssh=$(extract_filename &quot;$openSSH_URL&quot;)</span><br><span class="line">openssh_dir=$(extract_filename_exp &quot;$openssh&quot;)</span><br><span class="line">extract_tar_gz &quot;$download_dir$openssh&quot; &quot;/opt/$&#123;option_date&#125;/&quot;</span><br><span class="line">cd /opt/$&#123;option_date&#125;/$openssh_dir</span><br><span class="line">./configure --prefix=/usr/local/openssh --sysconfdir=/etc/ssh --with-ssl-dir=/usr/local/openssl --with-zlib=/usr/local/zlib </span><br><span class="line">make -j</span><br><span class="line">make install -j</span><br><span class="line">echo &#x27;export PATH=/usr/local/openssh/bin:$PATH&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">##创建软连接##</span><br><span class="line">ln -snf /usr/local/openssh/bin/ssh-keygen /usr/bin/ssh-keygen</span><br><span class="line"># ssh-keygen需要依赖openssl的libcrypto</span><br><span class="line">ln -snf /usr/local/openssl/lib64/libcrypto.so.3 /usr/lib64/libcrypto.so.3</span><br><span class="line">ln -snf /usr/local/openssh/sbin/sshd /usr/sbin/sshd</span><br><span class="line"></span><br><span class="line">##还原配置文件##</span><br><span class="line">cd /etc/ssh &amp;&amp; mv -f &quot;/etc/ssh/sshd_config$backup_name&quot; sshd_config</span><br><span class="line">cd /etc/pam.d &amp;&amp; mv -f &quot;/etc/pam.d/sshd$backup_name&quot; sshd</span><br><span class="line"></span><br><span class="line">##注释不支持配置项##</span><br><span class="line">sed -i &#x27;s/^GSSAPIAuthentication/#&amp;/&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -i &#x27;s/^GSSAPICleanupCredentials/#&amp;/&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -i &#x27;s/^UsePAM/#&amp;/&#x27; /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">##防止升级后ssh-v查询为旧版本号##</span><br><span class="line">#ssh_path=$(which ssh)</span><br><span class="line">#mv &quot;$&#123;ssh_path&#125;&quot; &quot;$&#123;ssh_path&#125;$&#123;$backup_name&#125;&quot;</span><br><span class="line">#sshd_path=$&#123;which sshd&#125;</span><br><span class="line">#mv &quot;$&#123;sshd_path&#125;&quot; &quot;$&#123;sshd_path&#125;$&#123;$backup_name&#125;&quot;</span><br><span class="line">#cp /usr/local/openssh/bin/ssh /usr/bin/ssh</span><br><span class="line">#cp /usr/local/openssh/sbin/sshd  /usr/sbin/sshd</span><br><span class="line"></span><br><span class="line">##重启SSH服务##</span><br><span class="line">service sshd restart</span><br><span class="line"></span><br><span class="line">ssh_version=$(ssh -V 2&gt;&amp;1)</span><br><span class="line">echo &quot;ssh已安装，版本：$ssh_version&quot;</span><br></pre></td></tr></table></figure><h5 id="注意事项">注意事项</h5><p>我这边升级之后遇到问题有，<code>ssh -V</code>输出日志 ssh 是9.3版本的，当我执行<code>source /etc/profile</code>在执行<code>ssh -V</code>就是9.7版本的。</p><blockquote><p>参考博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/SyXk/p/14658194.html">Openssh升级后版本不对应</a></p></blockquote><hr><p>获取ssh位置</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">which ssh </span><br></pre></td></tr></table></figure><blockquote><p>/usr/bin/ssh</p></blockquote><p>获取sshd位置</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">which sshd</span><br></pre></td></tr></table></figure><blockquote><p>/usr/sbin/sshd</p></blockquote><p>备份ssh和sshd文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv /usr/bin/ssh /usr/bin/ssh.bak20240522</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv /usr/sbin/sshd /usr/sbin/sshd.bak20240522</span><br></pre></td></tr></table></figure><p>通过环境变量配置文件可知，新升级ssh目录位置</p><blockquote><p>export PATH=/usr/local/openssh/bin:$PATH</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /usr/local/openssh/bin/ssh /usr/bin/ssh</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /usr/local/openssh/sbin/sshd  /usr/sbin/sshd</span><br></pre></td></tr></table></figure><p>再次验证ssh版本信息</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -V </span><br></pre></td></tr></table></figure><h3 id="防止ssh升级失败导致无法连接服务器">防止ssh升级失败导致无法连接服务器</h3><h4 id="防火墙Iptables">防火墙Iptables</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># ================================</span><br><span class="line"># Script Name: setup_telnet.sh</span><br><span class="line"># Description: This script installs and configures Telnet as a backup method for connecting to the server.</span><br><span class="line"># Author: Your Name</span><br><span class="line"># Date: YYYY-MM-DD</span><br><span class="line"># Version: 1.0</span><br><span class="line"># ================================</span><br><span class="line"></span><br><span class="line"># 检查是否以 root 用户运行</span><br><span class="line">if [ &quot;$(id -u)&quot; -ne 0 ]; then</span><br><span class="line">    echo &quot;请以 root 用户运行此脚本。&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 安装 Telnet 服务和 xinetd</span><br><span class="line">echo &quot;正在安装 Telnet 服务和 xinetd...&quot;</span><br><span class="line">yum install -y telnet-server xinetd</span><br><span class="line"></span><br><span class="line"># 配置 xinetd 启动 Telnet</span><br><span class="line">echo &quot;正在配置 xinetd 启动 Telnet...&quot;</span><br><span class="line">cat &lt;&lt;EOL &gt; /etc/xinetd.d/telnet</span><br><span class="line">service telnet</span><br><span class="line">&#123;</span><br><span class="line">    flags           = REUSE</span><br><span class="line">    socket_type     = stream</span><br><span class="line">    wait            = no</span><br><span class="line">    user            = root</span><br><span class="line">    server          = /usr/sbin/in.telnetd</span><br><span class="line">    log_on_failure  += USERID</span><br><span class="line">    disable         = no</span><br><span class="line">&#125;</span><br><span class="line">EOL</span><br><span class="line"></span><br><span class="line"># 启动并启用 xinetd 服务</span><br><span class="line">echo &quot;正在启动并启用 xinetd 服务...&quot;</span><br><span class="line">service xinetd start</span><br><span class="line">#systemctl enable xinetd #(如果当前命令不存在)</span><br><span class="line">chkconfig xinetd on</span><br><span class="line"></span><br><span class="line"># 使用 iptables 配置防火墙规则</span><br><span class="line">echo &quot;正在配置防火墙规则...&quot;</span><br><span class="line"># 允许 Telnet 连接</span><br><span class="line">iptables -I INPUT -p tcp --dport 23 -j ACCEPT</span><br><span class="line"># 提交规则更改</span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"># 提示成功信息</span><br><span class="line">echo &quot;Telnet 服务已成功安装并配置。请尽快测试 Telnet 连接并在不再需要时禁用该服务。&quot;</span><br><span class="line"></span><br><span class="line"># 提示测试 Telnet 连接的方法</span><br><span class="line">echo &quot;使用以下命令从另一台机器测试 Telnet 连接：&quot;</span><br><span class="line">echo &quot;telnet &lt;your_server_ip&gt;&quot;</span><br><span class="line"></span><br><span class="line"># 最后，重新加载 iptables 以应用新规则</span><br><span class="line">echo &quot;正在重新加载 iptables 配置...&quot;</span><br><span class="line">systemctl restart iptables</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="防火墙Firewalld">防火墙Firewalld</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># ================================</span><br><span class="line"># Script Name: setup_telnet.sh</span><br><span class="line"># Description: This script installs and configures Telnet as a backup method for connecting to the server.</span><br><span class="line"># Author: Your Name</span><br><span class="line"># Date: YYYY-MM-DD</span><br><span class="line"># Version: 1.0</span><br><span class="line"># ================================</span><br><span class="line"></span><br><span class="line"># 检查是否以 root 用户运行</span><br><span class="line">if [ &quot;$(id -u)&quot; -ne 0 ]; then</span><br><span class="line">    echo &quot;请以 root 用户运行此脚本。&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 安装 Telnet 服务和 xinetd</span><br><span class="line">echo &quot;正在安装 Telnet 服务和 xinetd...&quot;</span><br><span class="line">yum install -y telnet-server xinetd</span><br><span class="line"></span><br><span class="line"># 配置 xinetd 启动 Telnet</span><br><span class="line">echo &quot;正在配置 xinetd 启动 Telnet...&quot;</span><br><span class="line">cat &lt;&lt;EOL &gt; /etc/xinetd.d/telnet</span><br><span class="line">service telnet</span><br><span class="line">&#123;</span><br><span class="line">    flags           = REUSE</span><br><span class="line">    socket_type     = stream</span><br><span class="line">    wait            = no</span><br><span class="line">    user            = root</span><br><span class="line">    server          = /usr/sbin/in.telnetd</span><br><span class="line">    log_on_failure  += USERID</span><br><span class="line">    disable         = no</span><br><span class="line">&#125;</span><br><span class="line">EOL</span><br><span class="line"></span><br><span class="line"># 启动并启用 xinetd 服务</span><br><span class="line">echo &quot;正在启动并启用 xinetd 服务...&quot;</span><br><span class="line">systemctl start xinetd</span><br><span class="line">systemctl enable xinetd</span><br><span class="line"></span><br><span class="line"># 确认防火墙允许 Telnet 连接</span><br><span class="line">echo &quot;正在配置防火墙以允许 Telnet 连接...&quot;</span><br><span class="line">firewall-cmd --permanent --add-port=23/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"># 提示成功信息</span><br><span class="line">echo &quot;Telnet 服务已成功安装并配置。请尽快测试 Telnet 连接并在不再需要时禁用该服务。&quot;</span><br><span class="line"></span><br><span class="line"># 提示测试 Telnet 连接的方法</span><br><span class="line">echo &quot;使用以下命令从另一台机器测试 Telnet 连接：&quot;</span><br><span class="line">echo &quot;telnet &lt;your_server_ip&gt;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="禁用telnet服务">禁用telnet服务</h4><p>centos6</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service xinetd stop</span><br><span class="line">chkconfig xinetd off</span><br><span class="line">yum remove -y telnet-server xinetd</span><br></pre></td></tr></table></figure><p>centos7</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop xinetd</span><br><span class="line">systemctl disable xinetd</span><br><span class="line">yum remove -y telnet-server xinetd</span><br></pre></td></tr></table></figure><h4 id="SSH升级后，无法使用ftp服务">SSH升级后，无法使用ftp服务</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013008898/article/details/129726480">升级OpenSSH后SFTP无法连接问题修改</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim  /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#override default of no subsystems</span><br><span class="line">#Subsystem      sftp    /usr/local/openssh/libexec/sftp-server改成下面这句</span><br><span class="line">Subsystem      sftp    internal-sftp</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.wo0ow.com">MUMU</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.wo0ow.com/32797.html">https://www.wo0ow.com/32797.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a> 许可协议。转载请注明来自 <a href="https://www.wo0ow.com" target="_blank">MBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/52882.html" title="通过VM虚拟机proxy代理让宿主机访问vpn加密网络"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">通过VM虚拟机proxy代理让宿主机访问vpn加密网络</div></div></a></div><div class="next-post pull-right"><a href="/51066.html" title="Vue相关错误记录"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Vue相关错误记录</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/124662384" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">MUMU</div><div class="author-info__description">love yourself.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">272</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">91</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#IpTables"><span class="toc-text">IpTables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E7%89%B9%E5%AE%9AIP%E8%AE%BF%E9%97%AESSH%E7%AB%AF%E5%8F%A3"><span class="toc-text">允许特定IP访问SSH端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%AA%8C%E8%AF%81"><span class="toc-text">查看验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="toc-text">删除防火墙规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E9%98%B2%E7%81%AB%E5%A2%99%E5%B7%B2%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="toc-text">统计防火墙已配置规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF"><span class="toc-text">防火墙是否开启</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld"><span class="toc-text">Firewalld</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E7%89%B9%E5%AE%9AIP%E8%AE%BF%E9%97%AESSH%E7%AB%AF%E5%8F%A3-2"><span class="toc-text">允许特定IP访问SSH端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%BD%BD%E8%A7%84%E5%88%99"><span class="toc-text">重载规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%A7%84%E5%88%99"><span class="toc-text">查看规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%A7%84%E5%88%99"><span class="toc-text">删除规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E6%97%A7%E3%80%91%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E9%98%B2%E7%81%AB%E5%A2%99%E7%B1%BB%E5%9E%8B"><span class="toc-text">【旧】判断当前防火墙类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E4%BF%A1%E6%81%AF"><span class="toc-text">补充信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E6%96%B0%E3%80%91%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E9%98%B2%E7%81%AB%E5%A2%99%E7%B1%BB%E5%9E%8B%EF%BC%88%E5%B7%B2%E4%BC%98%E5%8C%96%EF%BC%89"><span class="toc-text">【新】判断当前防火墙类型（已优化）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E9%85%8D%E7%BD%AE"><span class="toc-text">防火墙端口转发配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSH-%E8%BF%9E%E6%8E%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AB%AF%E5%8F%A3%E5%91%BD%E4%BB%A4"><span class="toc-text">SSH 连接自定义端口命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Firewalld%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99"><span class="toc-text">Firewalld端口转发规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFFirewalld%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-text">开启Firewalld端口转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99"><span class="toc-text">添加端口转发规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99"><span class="toc-text">查询端口转发规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99"><span class="toc-text">删除端口转发规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E6%95%B4SSH%E7%AB%AF%E5%8F%A3"><span class="toc-text">调整SSH端口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-text">脚本命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3"><span class="toc-text">修改默认端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%A4%9A%E4%B8%AA%E7%AB%AF%E5%8F%A3"><span class="toc-text">监听多个端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AFSSH%E6%9C%8D%E5%8A%A1"><span class="toc-text">重启SSH服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bsshd%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%83%85%E5%86%B5"><span class="toc-text">查看sshd的端口情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E4%BF%AE%E6%94%B9selinux"><span class="toc-text">补充：修改selinux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%8B%E5%8D%B3%E7%94%9F%E6%95%88%E6%96%B9%E6%A1%88"><span class="toc-text">立即生效方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E9%87%8D%E5%90%AF%E6%96%B9%E6%A1%88"><span class="toc-text">需要重启方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4-2"><span class="toc-text">脚本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="toc-text">添加防火墙规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenSSH%E4%BF%AE%E5%A4%8DCVE-2023-38408%E6%BC%8F%E6%B4%9E"><span class="toc-text">OpenSSH修复CVE-2023-38408漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Centos6-%E5%8D%87%E7%BA%A7-OpenSSH%E4%BF%AE%E5%A4%8DCVE-2023-38408%E6%BC%8F%E6%B4%9E"><span class="toc-text">Centos6 升级 (OpenSSH修复CVE-2023-38408漏洞)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Centos6-%E5%8D%87%E7%BA%A7-OpenSSH%E4%BF%AE%E5%A4%8DCVE-2023-38408%E6%BC%8F%E6%B4%9E-%E3%80%90SH%E8%84%9A%E6%9C%AC%E7%89%88%E3%80%91"><span class="toc-text">Centos6 升级 (OpenSSH修复CVE-2023-38408漏洞)【SH脚本版】</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2ssh%E5%8D%87%E7%BA%A7%E5%A4%B1%E8%B4%A5%E5%AF%BC%E8%87%B4%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">防止ssh升级失败导致无法连接服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99Iptables"><span class="toc-text">防火墙Iptables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99Firewalld"><span class="toc-text">防火墙Firewalld</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%81%E7%94%A8telnet%E6%9C%8D%E5%8A%A1"><span class="toc-text">禁用telnet服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH%E5%8D%87%E7%BA%A7%E5%90%8E%EF%BC%8C%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8ftp%E6%9C%8D%E5%8A%A1"><span class="toc-text">SSH升级后，无法使用ftp服务</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/11613.html" title="线上环境问题排查-NoSuchMethodError">线上环境问题排查-NoSuchMethodError</a><time datetime="2024-08-03T08:04:00.000Z" title="发表于 2024-08-03 16:04:00">2024-08-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/39293.html" title="Nginx下配置文件微信校验文件">Nginx下配置文件微信校验文件</a><time datetime="2024-07-31T09:44:00.000Z" title="发表于 2024-07-31 17:44:00">2024-07-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/30838.html" title="sh脚本备份nginx日志并上传ftp服务器">sh脚本备份nginx日志并上传ftp服务器</a><time datetime="2024-07-27T14:48:41.000Z" title="发表于 2024-07-27 22:48:41">2024-07-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/40769.html" title="ElementUI组件-upload上传组件使用">ElementUI组件-upload上传组件使用</a><time datetime="2024-07-20T06:33:36.000Z" title="发表于 2024-07-20 14:33:36">2024-07-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/23806.html" title="ElementUI组件-字典使用及回显">ElementUI组件-字典使用及回显</a><time datetime="2024-07-20T06:33:23.000Z" title="发表于 2024-07-20 14:33:23">2024-07-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="framework-info"><span>往事不回头，未来不将就</span></div><div class="footer_custom_text">Copyright © 2018-2024 wo0ow.com All rights Reserved<br><img style="width:15px;height:15px;top:3px;position:relative" src="/custom/icp/icp.png"> <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">渝ICP备18012869号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class="js-pjax"></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!0,preloadRatio:2,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a=c[o],i=function(){c=c.filter(function(t){return a!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(a)};(t=a).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),i()):(e=new Image,n=t.getAttribute("data-original"),e.onload=function(){t.src=n,t.removeAttribute("data-original"),i()},t.src!==n&&(e.src=n))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this)</script></body></html>